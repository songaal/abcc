package org.fastcatsearch.ir.io;

import org.junit.Test;

import java.io.*;
import java.util.ArrayList;
import java.util.List;

/**
 * 하나의 파일을 여러번 열때와, 여러개의 파일을 한번식 열때 too many file open error 가 달라지는지 확인하기 위한 테스트
 *
 * 테스트결과는 파일은 상관없이 FileInputStream로 파일을 연 갯수만 계산된다.
 *
 * 아래 두 테스트는 결국 동일한 갯수에서 too many file open error가 발생한다.
 *
 * Created by swsong on 2016. 2. 25..
 */
public class TooManyFileOpenTest {

    @Test
    public void testOpenManyFiles() {

        int i = 0;
        List<File> fileList = new ArrayList<File>();
        try {
            while (true) {
                File f = File.createTempFile("TooManyFileOpenTest", Integer.toString(i));
                InputStream is = new FileInputStream(f);
                i++;
                fileList.add(f);
                if(i % 1000 == 0) {
                    System.out.println(i + "..");
                }
            }
        } catch (IOException t) {
            System.out.println("Max open file size1 = " + i);
            t.printStackTrace();
        } finally {
            for(File f: fileList) {
                f.delete();
            }
        }
    }

    @Test
    public void testOpenUniqFileMultiple() throws IOException {

        int i = 0;
        File f = File.createTempFile("testOpenUniqFileMultiple", null);
        try {
            while (true) {
                InputStream is = new FileInputStream(f);
                i++;
                if(i % 1000 == 0) {
                    System.out.println(i + "..");
                }
            }
        } catch (IOException t) {
            System.out.println("Max open file size2 = " + i);
            t.printStackTrace();
        } finally {
            f.delete();
        }

    }
}
